var e=require("../../config.json"),t=(e.verbose,require("../events/emiter.js").instance),n=require("mysql"),i=null;(i=e["db_"+e.enviroment]).multipleStatements=!0;var a=n.createPool(i);module.exports=function(e){function n(e){let t=m.entities[e],n=null;return t?(n=m.tables[t.table],n.name=t.table,n):(n=m.tables[e],n.name=e,n)}function i(e,t){let n=m.entities[e];return n?n.translate&&t?"view_"+n.table+"_"+t:"view_"+n.table:e}function l(e){let t=[],i=n(e.entity||e.table);return i.fields.forEach(n=>{t.push("`"+i.name+"_"+e.name+"`.`"+n.name+"` `"+i.name+"_"+e.name+"_"+n.name+"`")}),t.join(",")}function r(e,t){return new Promise((n,i)=>{t.query(e,(e,a,l)=>{e?i(e):n(a),t.release()})})}function s(t,a){let r="`base`.*",s=`SELECT {{SELECTION}} FROM \`${t}\` \`base\` `;return e.relations&&e.relations.forEach(t=>{if("1-1"===t.type)if(m.entities[t.entity]&&m.entities[t.entity].translate&&t.entity!=e.entity){let e=m.entities[t.entity],l=i(t.entity,a),o=n(t.entity),f=n(e.translate.table),u=[];o.fields.forEach(e=>{e.name!==t.leftKey&&u.push("`"+l+"_"+t.name+"`.`"+e.name+"` `"+o.name+"_"+t.name+"_"+e.name+"`")}),f.fields.forEach(t=>{t.name!==e.translate.rightKey&&u.push("`"+l+"`.`"+f.name+"_"+t.name+"` `"+o.name+"_"+t.name+"`")}),r+=`,${u.join(",")} `,s+=`LEFT JOIN \`${l}\` \`${l}_${t.name}\` ON \`base\`.\`${t.leftKey}\` = \`${l}_${t.name}\`.\`${o.defaultSort}\` `}else{r+=`,${l(t)} `;let e=n(t.entity);s+=`LEFT JOIN \`${e.name}\` \`${e.name}_${t.name}\` ON \`base\`.\`${t.leftKey}\` = \`${e.name}_${t.name}\`.\`${e.defaultSort}\` `}}),s=s.replace(new RegExp("{{SELECTION}}","g"),r),`CREATE OR REPLACE VIEW view_${e.table}${a?"_"+a:""} AS ${s};`}function o(t,i){let a=t.language,l=m.entities[e.entity],r=n(e.entity),s=m.tables[l.translate.table],o=" WHERE "+l.translate.rightKey+"="+t[r.defaultSort]+" AND id_lang ="+a,f="DELETE FROM "+l.translate.table+o+"; INSERT INTO "+l.translate.table+" ",u="(",d="(";return t.id_lang=a,t[l.translate.rightKey]=t[r.defaultSort],s.fields.forEach(e=>{u+="`"+e.name+"`,",d+=i.escape(t[e.name])+","}),u=u.slice(0,-1)+")",d=d.slice(0,-1)+")",f+=u+" VALUES "+d,f="SET FOREIGN_KEY_CHECKS= 0;"+f+"SET FOREIGN_KEY_CHECKS = 1;"}let f=require("./entities.js"),u=require("./tables.js"),m={entities:f.entities,tables:u.tables};this.getPrimaryKey=function(){let t=null;return n(e.entity).fields.forEach(e=>{e.key&&(t=e.name)}),t},this.updateView=function(){if(e.translate)return this.customQuery("SELECT * FROM lang").then(t=>{let i="";return t.forEach(t=>{i+=s(function(t){return`(SELECT ${e.table}.*,${l(e.translate)} FROM  ${e.table}\n\t\t\t\t LEFT JOIN ${e.translate.table}  ON ${e.translate.table}.${e.translate.rightKey} = ${e.table}.${n(e.table).defaultSort} AND ${e.translate.table}.id_lang = '${t}')`}(t.id),t.id)}),this.customQuery(i)});{let t=s(e.table,null);return this.customQuery(t)}},this.getAll=function(e){return e=e||{limit:10,page:1},this.getFiltered(e)},this.getByUid=function(t){let i={filter_fields:[n(e.entity).defaultSort],filter_values:[t]};return this.getFiltered(i)},this.getByUids=function(t){return new Promise((n,i)=>{a.getConnection((a,l)=>{a&&i(a);var s="";for(var o in t)s+="list.Uid = "+l.escape(t[o])+" AND ";s=s.slice(0,-4),r("SELECT * FROM `"+e.table+"` AS list WHERE "+s,l).then(n,i)})})},this.getByParams=function(e){let t={filter_fields:[],filter_values:[]};for(var n in e)n.indexOf(".")>-1&&(t.simple=!1),t.filter_fields.push(n),t.filter_values.push(e[n]);return this.getFiltered(t)},this.sintetizeRelation=function(t,i){let a=m.entities[i.entity],l={};if(n(i.entity).fields.forEach(e=>{"password"!==e.name&&(l[e.name]=t[e.name])}),!a)return l;if(a.translate){let e=n(a.translate.table);e.fields.forEach(n=>{l[n.name]||(l[n.name]=t[e.name+"_"+n.name])})}return a.relations&&a.relations.forEach(e=>{if("1-1"===e.type){let i={},a=m.entities[e.entity],r=n(e.entity||e.table),s=r.fields;if(a&&a.translate){let e=n(a.translate.table);s=s.concat(e.fields)}s.forEach(n=>{"password"!==n.name&&(i[n.name]||(i[n.name]=t[r.name+"_"+e.name+"_"+n.name]))}),l[e.name||e.entity]=i}}),i.intermediate&&(l[n(e.table).defaultSort]=l[n(e.table).defaultSort]||t[i.intermediate.leftKey]),l},this.getFiltered=function(t){return new Promise((l,s)=>{a.getConnection((a,o)=>{function f(e,t,n){if("string"!=typeof t)return n+e.escape(t);let i=t.split(" ");return i.length>1?(n=i.splice(0,1))+e.escape(i.join(" ")):n+e.escape(t)}a&&s(a);let u={};var d={},h="";t.limit=t.limit||20,t.page=t.page||1,t.lang=t.lang||1,t._join=t._join||"OR",void 0===t.simple&&(t.simple=!0),t.simple=JSON.parse(t.simple),t.order=t.order||n(e.entity).defaultSort,t.filter_fields=t.filter_fields||[],t.filter_values=t.filter_values||[],"string"==typeof t.filter_fields&&(t.filter_fields=[t.filter_fields],t.filter_values=[t.filter_values]),t.fields=t.fields||[],"string"==typeof t.fields&&(t.fields=[t.fields]),0===t.order.indexOf("-")&&(t.order=t.order.substring(1)+" desc"),t.filter_fields.forEach((e,n)=>{if(-1!==e.indexOf(".")){let i=e.split("."),a=i[0],l=i[1];d[a]||(d[a]={}),d[a][l]||(d[a][l]=[]),d[a][l].push(f(o,t.filter_values[n],""))}else u[e]||(u[e]=[]),u[e].push(f(o,t.filter_values[n],"= "))});let E="";if(t.filter&&t.filter.length>0){let a=m.entities[e.entity],l=i(e.entity,t.lang),r=n(e.entity),s=null;a&&a.translate&&(s=n(a.translate.table));let f=[];r.fields.forEach(e=>{"string"!==e.type&&"text"!==e.type||f.push("`"+l+"`.`"+e.name+"`")}),s&&s.fields.forEach(e=>{e.name===a.translate.rightKey||"string"!==e.type&&"text"!==e.type||f.push(s.name+"_"+e.name)}),e.relations&&!1===t.simple&&e.relations.forEach(e=>{let a=n(e.entity||e.table),l=i(e.entity||e.table,t.lang)+"_"+e.name;a.fields.forEach(e=>{"string"!==e.type&&"text"!==e.type||f.push("`"+l+"`.`"+e.name+"`")})}),E=[];for(var y in f)E.push(f[y]+" like "+o.escape("%"+t.filter.split(" ").join("%")+"%"));E="("+E.join(" OR ")+")"}let c="";if(t.filter_fields.length>0){let n=i(e.entity,t.lang);for(var g in u){c+="(";for(var p in u[g])c+="`"+n+"`.`"+g+"`"+u[g][p]+" "+t._join+" ";c=c.slice(0,-4),c+=") AND "}}let _="`"+i(e.entity,t.lang)+"`",$=_,S=0;e.relations&&!1===t.simple&&e.relations.forEach(a=>{let l=i(a.entity,t.lang);for(let e in d)if(a.name==e){c+="(";for(let t in d[e])if(0==d[e][t][0].indexOf("'"))c+=`\`${l+"_"+a.name+"`.`"+t}\` IN ( ${d[e][t]} ) AND `;else for(var r in d[e][t]){let n=d[e][t][r];c+=`\`${l+"_"+a.name+"`.`"+t}\` ${n} AND `}c=c.slice(0,-4)+") AND "}let s=[];if(a.intermediate){let r=i(a.intermediate.entity,t.lang);s.push(`LEFT JOIN \`${r}\` \`intermediate_${S}\` ON \`intermediate_${S}\`.\`${a.intermediate.leftKey}\` = ${_}.\`${n(e.table).defaultSort}\`\n\t\t\t\t\t\t\tLEFT JOIN \`${l}\` \`${l+"_"+a.name}\` ON \`intermediate_${S}\`.\`${a.intermediate.rightKey}\` = \`${l+"_"+a.name}\`.\`${n(a.entity).defaultSort}\``)}else if(a.rightKey)s.push(`LEFT JOIN \`${l}\` \`${l+"_"+a.name}\` ON \`${l+"_"+a.name}\`.\`${a.rightKey}\` = ${_}.\`${n(e.table).defaultSort}\``);else if(a.leftKey){let e=n(a.entity||a.table);s.push(`LEFT JOIN \`${l}\` \`${l+"_"+a.name}\` ON \`${l+"_"+a.name}\`.\`${e.defaultSort}\` = ${_}.\`${a.leftKey}\``)}$=$+" "+s,S++}),c=c.slice(0,-5),h=E.length>0&&c.length>0?E+" AND "+c:E+c;var O="SELECT SQL_CALC_FOUND_ROWS `"+i(e.entity,t.lang)+"`.`"+n(e.table).defaultSort+"` `key` FROM "+$+" ";return h.length>2&&(O+="WHERE "+h),O+="GROUP BY `key` ",O+="ORDER BY `"+i(e.entity,t.lang)+"`."+t.order+" LIMIT "+(parseInt(t.page)-1)*t.limit+","+t.limit+";",O+="SELECT FOUND_ROWS() as total",r(O,o).then(a=>{let r=[];for(let e in a[0])r.push(a[0][e].key);let o=a[1][0].total;if(0===r.length)return void l({data:[],total_results:0});r=r.join(","),O="SELECT * FROM `"+i(e.entity,t.lang)+"` WHERE `"+n(e.table).defaultSort+"` IN ("+r+") ORDER BY "+t.order+";";let f=0;if(!1===t.simple&&e.relations)for(let a=0;a<e.relations.length;a++){let l=e.relations[a];switch(l.type){case"1-n":f++,O+=`SELECT * FROM \`${i(l.entity,t.lang)}\` WHERE \`${i(l.entity,t.lang)}\`.\`${l.rightKey}\` IN (${r});`;break;case"n-n":f++,O+=`SELECT * FROM \`${i(l.entity,t.lang)}\`\n\t\t\t\t\t\t\tLEFT JOIN \`${i(l.intermediate.entity,t.lang)}\` \`intermediate\` ON \`intermediate\`.\`${l.intermediate.rightKey}\` = \`${i(l.entity,t.lang)}\`.\`${n(l.entity).defaultSort}\`\n\t\t\t\t\t\t\tWHERE \`intermediate\`.\`${l.intermediate.leftKey}\` IN (${r});`}}return this.customQuery(O).then(t=>{let i=null;0==f?delete(i=t).password:i=t[0];let a={},r=[];if(e.relations){e.relations.forEach(e=>{"1-1"!==e.type&&r.push(e)});for(let e=1;e<t.length;e++){let n=t[e];for(let t=0;t<n.length;t++){let i=r[e-1],l=this.sintetizeRelation(n[t],i),s=i.rightKey;i.intermediate&&(s=i.intermediate.leftKey),a[s=n[t][s]]||(a[s]={}),a[s][i.name]||(a[s][i.name]=[]),a[s][i.name].push(l)}}}let s=[];for(let t=0;t<i.length;t++){let l=this.sintetizeRelation(i[t],e),r=l[n(e.table).defaultSort];if(a[r])for(j in a[r])l[j]=a[r][j];s.push(l)}l({data:s,total_results:o})},s)},s)})})},this.createMultiple=function(t){let n=t.data,i=t.col_names;var a="INSERT INTO "+e.table+" ("+i.join(",")+") VALUES ";for(let e in n){a+="(";for(let t in i)void 0===n[e][i[t]]?a+="NULL,":a+="'"+n[e][i[t]]+"',";a=a.slice(0,-1),a+="),"}return a=a.slice(0,-1),this.customQuery(a)},this.create=function(i){return new Promise((l,s)=>{a.getConnection((f,u)=>{f&&s(f);let d=m.entities[e.entity],h=n(e.entity);return r(function(e,t,n){var i="(",a="(";return e.fields.forEach(e=>{t[e.name]&&(i+="`"+e.name+"`,",a+=n.escape(t[e.name])+",")}),i=i.slice(0,-1)+")",a=a.slice(0,-1)+")","INSERT INTO `"+e.name+"` "+i+" VALUES "+a}(h,i,u),u).then(e=>(e.insertId&&(i[h.defaultSort]=e.insertId),d.translate?new Promise((e,t)=>{a.getConnection((n,a)=>{n&&t(n),r(o(i,a),a).then(e,t)})}):void 0),s).then(()=>{t.emit(e.entity+".created",i),this.updateView(),l(i)},s)})})},this.update=function(i,l){let s=m.entities[e.entity],f=n(e.entity),u=null;return this.getByParams(l).then(n=>(u=n.data[0],new Promise((n,m)=>{a.getConnection((d,h)=>{d&&m(d),r(function(e,t,n,i){var a="",l="(";if(e.fields.forEach(e=>{"timestamp"!=e.name&&null!==t[e.name]&&void 0!==t[e.name]&&(!1===t[e.name]&&(t[e.name]=0),a+="`"+e.name+"`="+n.escape(t[e.name])+",",e.key&&!i&&(l+="`"+e.name+"`="+n.escape(t[e.name])+" AND "))}),i)for(var r in i)l+="`"+r+"`="+n.escape(i[r])+" AND ";return a=a.slice(0,-1),l=l.slice(0,-5)+")","UPDATE `"+e.name+"` SET "+a+" WHERE "+l}(f,i,h,l),h).then(e=>s.translate?new Promise((e,t)=>{a.getConnection((n,a)=>{n&&t(n),r(o(i,a),a).then(e,t)})}):void 0,m).then(()=>this.updateView(),m).then(()=>{let e=i[this.getPrimaryKey()];return e?this.getByUid(e):null},m).then(a=>{let l=null;a&&a.data&&(l=a.data[0],t.emit(e.entity+".updated",u,l,i)),n(l)},m)})})))},this.delete=function(i){let l={};return n(e.entity).fields.forEach(e=>{i[e.name]&&(l[e.name]=i[e.name])}),new Promise((n,i)=>{a.getConnection((a,s)=>{a&&i(a);var o="";for(var f in l)o+=f+function(e,t,n){if("string"!=typeof t)return n+e.escape(t);let i=t.split(" ");return i.length>1?(n=i.splice(0,1))+e.escape(i.join(" ")):n+e.escape(t)}(s,l[f]," = ")+" AND ";o=o.slice(0,-4);var u="SELECT * FROM "+e.table+" WHERE "+o,m="DELETE FROM "+e.table+" WHERE "+o;return m="SET FOREIGN_KEY_CHECKS= 1;"+m+";SET FOREIGN_KEY_CHECKS = 1;",r(u,s).then(n=>(t.emit(e.entity+".deleted",n[0]),this.customQuery(m)),i).then(()=>{this.updateView(),n()},i)})})},this.customQuery=function(e){return new Promise((t,n)=>{a.getConnection((i,a)=>{i&&n(i),r(e,a).then(t,n)})})}};